<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manga Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .card {
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .hidden {
            display: none;
        }
        #imagePreview {
            max-height: 200px;
            object-fit: contain;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-purple-400">Manga Tracker</h1>
            <div class="flex items-center space-x-4">
                <button id="addBtn" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg">
                    <i class="fas fa-plus mr-2"></i>Add Manga
                </button>
                <button id="settingsBtn" class="p-2 rounded-full hover:bg-gray-700">
                    <i class="fab fa-github text-xl"></i>
                </button>
            </div>
        </header>

        <!-- Search and Filter -->
        <div class="mb-8 bg-gray-800 p-4 rounded-lg">
            <div class="flex flex-col md:flex-row md:items-center md:space-x-4 space-y-4 md:space-y-0">
                <div class="flex-1">
                    <input type="text" id="searchInput" placeholder="Search by title..." class="w-full bg-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="flex space-x-4">
                    <select id="typeFilter" class="bg-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="all">All Types</option>
                        <option value="manga">Manga</option>
                        <option value="manhwa">Manhwa</option>
                        <option value="manhua">Manhua</option>
                    </select>
                    <button id="searchBtn" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg">
                        <i class="fas fa-search mr-2"></i>Search
                    </button>
                </div>
            </div>
        </div>

        <!-- Manga Grid -->
        <div id="mangaGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- Manga cards will be inserted here by JavaScript -->
        </div>

        <!-- Add/Edit Manga Modal -->
        <div id="mangaModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold" id="modalTitle">Add New Manga</h2>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="mangaForm">
                    <input type="hidden" id="mangaId">
                    <div class="mb-4">
                        <label class="block mb-2">Cover Image</label>
                        <div class="flex items-center space-x-4">
                            <label for="coverUpload" class="cursor-pointer bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg">
                                <i class="fas fa-upload mr-2"></i>Upload
                            </label>
                            <input type="file" id="coverUpload" accept="image/*" class="hidden">
                            <img id="imagePreview" src="" alt="Preview" class="hidden rounded-lg max-h-20">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="title" class="block mb-2">Title</label>
                        <input type="text" id="title" required class="w-full bg-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div class="mb-4">
                        <label for="chapter" class="block mb-2">Chapter</label>
                        <input type="text" id="chapter" required class="w-full bg-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div class="mb-4">
                        <label for="type" class="block mb-2">Type</label>
                        <select id="type" required class="w-full bg-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="manga">Manga</option>
                            <option value="manhwa">Manhwa</option>
                            <option value="manhua">Manhua</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="rating" class="block mb-2">Rating (1-5)</label>
                        <div class="flex items-center">
                            <input type="range" id="rating" min="1" max="5" step="0.5" value="3" class="w-full mr-4">
                            <span id="ratingValue" class="text-purple-400 font-bold">3</span>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="fansub" class="block mb-2">Fansub/Scanlation</label>
                        <input type="text" id="fansub" class="w-full bg-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div class="mb-4">
                        <label for="readDate" class="block mb-2">Read Date</label>
                        <input type="date" id="readDate" required class="w-full bg-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancelBtn" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded-lg">Cancel</button>
                        <button type="submit" id="saveBtn" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">GitHub Settings</h2>
                    <button id="closeSettings" class="text-gray-400 hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="settingsForm">
                    <div class="mb-4">
                        <label for="githubUsername" class="block mb-2">GitHub Username</label>
                        <input type="text" id="githubUsername" required class="w-full bg-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div class="mb-4">
                        <label for="githubRepo" class="block mb-2">Repository Name</label>
                        <input type="text" id="githubRepo" required class="w-full bg-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div class="mb-4">
                        <label for="githubToken" class="block mb-2">Personal Access Token</label>
                        <input type="password" id="githubToken" required class="w-full bg-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <p class="text-xs text-gray-400 mt-1">Create a token with repo permissions at GitHub</p>
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancelSettings" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded-lg">Cancel</button>
                        <button type="submit" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg">Save Settings</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let mangaList = [];
        let filteredMangaList = [];
        let githubConfig = {
            username: localStorage.getItem('githubUsername') || '',
            repo: localStorage.getItem('githubRepo') || '',
            token: localStorage.getItem('githubToken') || ''
        };

        // DOM Elements
        const mangaGrid = document.getElementById('mangaGrid');
        const mangaModal = document.getElementById('mangaModal');
        const settingsModal = document.getElementById('settingsModal');
        const mangaForm = document.getElementById('mangaForm');
        const settingsForm = document.getElementById('settingsForm');
        const searchInput = document.getElementById('searchInput');
        const typeFilter = document.getElementById('typeFilter');
        const searchBtn = document.getElementById('searchBtn');
        const addBtn = document.getElementById('addBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const coverUpload = document.getElementById('coverUpload');
        const imagePreview = document.getElementById('imagePreview');
        const ratingInput = document.getElementById('rating');
        const ratingValue = document.getElementById('ratingValue');

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Check if GitHub config is set
            if (githubConfig.username && githubConfig.repo && githubConfig.token) {
                loadMangaData();
            } else {
                settingsModal.classList.remove('hidden');
            }
            
            // Set current date as default
            document.getElementById('readDate').valueAsDate = new Date();
        });

        addBtn.addEventListener('click', () => {
            mangaForm.reset();
            document.getElementById('modalTitle').textContent = 'Add New Manga';
            document.getElementById('mangaId').value = '';
            imagePreview.src = '';
            imagePreview.classList.add('hidden');
            mangaModal.classList.remove('hidden');
        });

        settingsBtn.addEventListener('click', () => {
            document.getElementById('githubUsername').value = githubConfig.username;
            document.getElementById('githubRepo').value = githubConfig.repo;
            document.getElementById('githubToken').value = githubConfig.token;
            settingsModal.classList.remove('hidden');
        });

        document.getElementById('closeModal').addEventListener('click', () => mangaModal.classList.add('hidden'));
        document.getElementById('closeSettings').addEventListener('click', () => settingsModal.classList.add('hidden'));
        document.getElementById('cancelBtn').addEventListener('click', () => mangaModal.classList.add('hidden'));
        document.getElementById('cancelSettings').addEventListener('click', () => settingsModal.classList.add('hidden'));

        ratingInput.addEventListener('input', () => {
            ratingValue.textContent = ratingInput.value;
        });

        coverUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imagePreview.src = event.target.result;
                    imagePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        mangaForm.addEventListener('submit', (e) => {
            e.preventDefault();
            saveManga();
        });

        settingsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            saveGitHubConfig();
        });

        searchBtn.addEventListener('click', () => {
            filterManga();
        });

        // Functions
        async function loadMangaData() {
            try {
                const response = await fetch(`https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/bookmarks.json`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        // File doesn't exist yet, create empty array
                        mangaList = [];
                        renderMangaGrid();
                        return;
                    }
                    throw new Error('Failed to load data');
                }

                const data = await response.json();
                const content = atob(data.content);
                mangaList = JSON.parse(content);
                filteredMangaList = [...mangaList];
                renderMangaGrid();
            } catch (error) {
                console.error('Error loading manga data:', error);
                alert('Failed to load manga data. Check your GitHub settings.');
            }
        }

        async function saveMangaData() {
            try {
                // Check if file exists to get SHA for update
                let sha = '';
                try {
                    const checkResponse = await fetch(`https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/bookmarks.json`, {
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (checkResponse.ok) {
                        const checkData = await checkResponse.json();
                        sha = checkData.sha;
                    }
                } catch (e) {
                    console.log('File does not exist yet, will create new');
                }

                const content = btoa(JSON.stringify(mangaList, null, 2));
                const response = await fetch(`https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/bookmarks.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Update manga list',
                        content: content,
                        sha: sha
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save data');
                }

                console.log('Data saved successfully');
            } catch (error) {
                console.error('Error saving manga data:', error);
                alert('Failed to save manga data. Check your GitHub settings.');
            }
        }

        function saveManga() {
            const id = document.getElementById('mangaId').value;
            const title = document.getElementById('title').value;
            const chapter = document.getElementById('chapter').value;
            const type = document.getElementById('type').value;
            const rating = document.getElementById('rating').value;
            const fansub = document.getElementById('fansub').value;
            const readDate = document.getElementById('readDate').value;
            const coverImage = imagePreview.src || '';

            const mangaData = {
                title,
                chapter,
                type,
                rating,
                fansub,
                readDate,
                coverImage
            };

            if (id) {
                // Edit existing manga
                const index = mangaList.findIndex(manga => manga.id === id);
                if (index !== -1) {
                    mangaList[index] = { ...mangaData, id };
                }
            } else {
                // Add new manga
                mangaData.id = Date.now().toString();
                mangaList.unshift(mangaData);
            }

            saveMangaData().then(() => {
                filterManga();
                mangaModal.classList.add('hidden');
            });
        }

        function editManga(id) {
            const manga = mangaList.find(m => m.id === id);
            if (!manga) return;

            document.getElementById('modalTitle').textContent = 'Edit Manga';
            document.getElementById('mangaId').value = manga.id;
            document.getElementById('title').value = manga.title;
            document.getElementById('chapter').value = manga.chapter;
            document.getElementById('type').value = manga.type;
            document.getElementById('rating').value = manga.rating;
            document.getElementById('ratingValue').textContent = manga.rating;
            document.getElementById('fansub').value = manga.fansub || '';
            document.getElementById('readDate').value = manga.readDate;

            if (manga.coverImage) {
                imagePreview.src = manga.coverImage;
                imagePreview.classList.remove('hidden');
            } else {
                imagePreview.src = '';
                imagePreview.classList.add('hidden');
            }

            mangaModal.classList.remove('hidden');
        }

        function deleteManga(id) {
            if (confirm('Are you sure you want to delete this manga?')) {
                mangaList = mangaList.filter(manga => manga.id !== id);
                saveMangaData().then(() => {
                    filterManga();
                });
            }
        }

        function filterManga() {
            const searchTerm = searchInput.value.toLowerCase();
            const typeFilterValue = typeFilter.value;

            filteredMangaList = mangaList.filter(manga => {
                const matchesSearch = manga.title.toLowerCase().includes(searchTerm);
                const matchesType = typeFilterValue === 'all' || manga.type === typeFilterValue;
                return matchesSearch && matchesType;
            });

            renderMangaGrid();
        }

        function renderMangaGrid() {
            mangaGrid.innerHTML = '';

            if (filteredMangaList.length === 0) {
                mangaGrid.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <i class="fas fa-book-open text-4xl mb-4"></i>
                        <p>No manga found. Add your first manga!</p>
                    </div>
                `;
                return;
            }

            filteredMangaList.forEach(manga => {
                const card = document.createElement('div');
                card.className = 'card bg-gray-800 rounded-lg overflow-hidden shadow-lg hover:shadow-xl';
                card.innerHTML = `
                    <div class="relative">
                        ${manga.coverImage ? 
                            `<img src="${manga.coverImage}" alt="${manga.title}" class="w-full h-48 object-cover">` : 
                            `<div class="w-full h-48 bg-gray-700 flex items-center justify-center">
                                <i class="fas fa-book-open text-4xl text-gray-500"></i>
                            </div>`
                        }
                        <div class="absolute top-2 right-2 bg-black bg-opacity-70 px-2 py-1 rounded text-sm">
                            ${manga.type}
                        </div>
                        <div class="absolute top-2 left-2 bg-black bg-opacity-70 px-2 py-1 rounded text-sm">
                            ${Array.from({length: Math.floor(manga.rating)}, () => '★').join('')}${manga.rating % 1 ? '½' : ''}
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-lg truncate">${manga.title}</h3>
                        <p class="text-gray-400 text-sm">Chapter ${manga.chapter}</p>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-xs text-gray-500">${formatDate(manga.readDate)}</span>
                            <div class="flex space-x-2">
                                <button onclick="editManga('${manga.id}')" class="text-gray-400 hover:text-purple-400">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteManga('${manga.id}')" class="text-gray-400 hover:text-red-400">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                mangaGrid.appendChild(card);
            });
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        function saveGitHubConfig() {
            githubConfig.username = document.getElementById('githubUsername').value;
            githubConfig.repo = document.getElementById('githubRepo').value;
            githubConfig.token = document.getElementById('githubToken').value;

            localStorage.setItem('githubUsername', githubConfig.username);
            localStorage.setItem('githubRepo', githubConfig.repo);
            localStorage.setItem('githubToken', githubConfig.token);

            settingsModal.classList.add('hidden');
            loadMangaData();
        }

        // Make functions available globally for inline event handlers
        window.editManga = editManga;
        window.deleteManga = deleteManga;
    </script>
</body>
</html>